---
next:
  text: 'К содержанию'
  link: '/ml/ml_index'
prev: false
---

# Mean Target Encoding

> $x_{j}$ - категориальный
> $x$ - новый объект

$$g(x_{j}, X) = \frac{  \sum_{i=1}^{\ell} [x_{j} = x] y_{i}}{\sum_{j=1}^{\ell} [x_{i}=x_{j}]}$$

Считаем среднее таргета, которое принимают объекты из данной категории. Однако TE привдит к переобучению,

>[!info] Почему?
> 1. TE - простая модель, которая по целевому признаку предсказывает значение таргета $\implies$ Переобучение, так как оценки категорий не работают на новых данных. (модель привыкает к ошибкам меньшего порядка)
> 2. Для редких категорий в новом признаке будет записана целевая переменная (target leakage)

Как с этим бороться?

### 1. Зашумление
$$\bar{g}(x_{j}, \mathbb{X}) + \varepsilon, \varepsilon \sim N(0, \sigma^{2})$$
### 2. Сглаживание:

$$\begin{array}{lcl}
\bar{g}(x_{j}, X) &=& \lambda(n(x_{j})) \frac{ \sum_{i=1}^{\ell} [x_{ij}=x_{j}] y_{i} }{\sum_{i=1}^{\ell} [x_{ij} = x_{j}] } \\
&+& (1 - \lambda(n(x_{j}))) \frac{\sum_{i=1}^{\ell} y_{i} }{\ell}
\end{array}
$$
$$n(x_{j}) = \sum_{i=1}^{\ell} [x_{ij}=x_{j}]$$
где $\lambda(n)$ некоторая монотонная возрастающая функция $\in [0;1]$

Если:
- $n\gg 1 \implies \lambda(n)=1 \implies$ Обычное значение счетчика
- $n\sim 1 \implies \lambda(n) < 1 \implies$ Добавляем некоторую константу для маленьких категорий

### 3. Кросс-валидация

![alt](https://i.imgur.com/NzacSp7.png)

Для нового объекта считаем функцию $g$ как обычно.

Если нужно делать кроссвалидацию еще для выбора параметров:
![alt](https://i.imgur.com/HiSb6ld.png)

### 4. Кодирование по времени (импользуется по умолчанию в CatBoost)

**Идея**: для кодирования $x_{j}$ используем только объекты с $1$ по $(j - 1)$-ый. (Делаем несколько перемешиваний, а затем усредняем)
